revoke delete on table "public"."admin_actions" from "anon";

revoke insert on table "public"."admin_actions" from "anon";

revoke references on table "public"."admin_actions" from "anon";

revoke select on table "public"."admin_actions" from "anon";

revoke trigger on table "public"."admin_actions" from "anon";

revoke truncate on table "public"."admin_actions" from "anon";

revoke update on table "public"."admin_actions" from "anon";

revoke delete on table "public"."admin_actions" from "authenticated";

revoke references on table "public"."admin_actions" from "authenticated";

revoke trigger on table "public"."admin_actions" from "authenticated";

revoke truncate on table "public"."admin_actions" from "authenticated";

revoke update on table "public"."admin_actions" from "authenticated";

revoke delete on table "public"."analytics" from "anon";

revoke references on table "public"."analytics" from "anon";

revoke select on table "public"."analytics" from "anon";

revoke trigger on table "public"."analytics" from "anon";

revoke truncate on table "public"."analytics" from "anon";

revoke update on table "public"."analytics" from "anon";

revoke delete on table "public"."analytics" from "authenticated";

revoke references on table "public"."analytics" from "authenticated";

revoke trigger on table "public"."analytics" from "authenticated";

revoke truncate on table "public"."analytics" from "authenticated";

revoke update on table "public"."analytics" from "authenticated";

revoke delete on table "public"."bookings" from "anon";

revoke insert on table "public"."bookings" from "anon";

revoke references on table "public"."bookings" from "anon";

revoke select on table "public"."bookings" from "anon";

revoke trigger on table "public"."bookings" from "anon";

revoke truncate on table "public"."bookings" from "anon";

revoke update on table "public"."bookings" from "anon";

revoke delete on table "public"."bookings" from "authenticated";

revoke references on table "public"."bookings" from "authenticated";

revoke trigger on table "public"."bookings" from "authenticated";

revoke truncate on table "public"."bookings" from "authenticated";

revoke delete on table "public"."categories" from "anon";

revoke insert on table "public"."categories" from "anon";

revoke references on table "public"."categories" from "anon";

revoke trigger on table "public"."categories" from "anon";

revoke truncate on table "public"."categories" from "anon";

revoke update on table "public"."categories" from "anon";

revoke delete on table "public"."categories" from "authenticated";

revoke insert on table "public"."categories" from "authenticated";

revoke references on table "public"."categories" from "authenticated";

revoke trigger on table "public"."categories" from "authenticated";

revoke truncate on table "public"."categories" from "authenticated";

revoke update on table "public"."categories" from "authenticated";

revoke delete on table "public"."claim_photos" from "anon";

revoke insert on table "public"."claim_photos" from "anon";

revoke references on table "public"."claim_photos" from "anon";

revoke select on table "public"."claim_photos" from "anon";

revoke trigger on table "public"."claim_photos" from "anon";

revoke truncate on table "public"."claim_photos" from "anon";

revoke update on table "public"."claim_photos" from "anon";

revoke delete on table "public"."claim_photos" from "authenticated";

revoke references on table "public"."claim_photos" from "authenticated";

revoke trigger on table "public"."claim_photos" from "authenticated";

revoke truncate on table "public"."claim_photos" from "authenticated";

revoke delete on table "public"."claims" from "anon";

revoke insert on table "public"."claims" from "anon";

revoke references on table "public"."claims" from "anon";

revoke select on table "public"."claims" from "anon";

revoke trigger on table "public"."claims" from "anon";

revoke truncate on table "public"."claims" from "anon";

revoke update on table "public"."claims" from "anon";

revoke delete on table "public"."claims" from "authenticated";

revoke references on table "public"."claims" from "authenticated";

revoke trigger on table "public"."claims" from "authenticated";

revoke truncate on table "public"."claims" from "authenticated";

revoke delete on table "public"."connected_accounts" from "anon";

revoke insert on table "public"."connected_accounts" from "anon";

revoke references on table "public"."connected_accounts" from "anon";

revoke select on table "public"."connected_accounts" from "anon";

revoke trigger on table "public"."connected_accounts" from "anon";

revoke truncate on table "public"."connected_accounts" from "anon";

revoke update on table "public"."connected_accounts" from "anon";

revoke delete on table "public"."connected_accounts" from "authenticated";

revoke references on table "public"."connected_accounts" from "authenticated";

revoke trigger on table "public"."connected_accounts" from "authenticated";

revoke truncate on table "public"."connected_accounts" from "authenticated";

revoke delete on table "public"."conversations" from "anon";

revoke insert on table "public"."conversations" from "anon";

revoke references on table "public"."conversations" from "anon";

revoke select on table "public"."conversations" from "anon";

revoke trigger on table "public"."conversations" from "anon";

revoke truncate on table "public"."conversations" from "anon";

revoke update on table "public"."conversations" from "anon";

revoke delete on table "public"."conversations" from "authenticated";

revoke references on table "public"."conversations" from "authenticated";

revoke trigger on table "public"."conversations" from "authenticated";

revoke truncate on table "public"."conversations" from "authenticated";

revoke delete on table "public"."email_notifications" from "anon";

revoke insert on table "public"."email_notifications" from "anon";

revoke references on table "public"."email_notifications" from "anon";

revoke select on table "public"."email_notifications" from "anon";

revoke trigger on table "public"."email_notifications" from "anon";

revoke truncate on table "public"."email_notifications" from "anon";

revoke update on table "public"."email_notifications" from "anon";

revoke delete on table "public"."email_notifications" from "authenticated";

revoke insert on table "public"."email_notifications" from "authenticated";

revoke references on table "public"."email_notifications" from "authenticated";

revoke trigger on table "public"."email_notifications" from "authenticated";

revoke truncate on table "public"."email_notifications" from "authenticated";

revoke update on table "public"."email_notifications" from "authenticated";

revoke delete on table "public"."escrow_transactions" from "anon";

revoke insert on table "public"."escrow_transactions" from "anon";

revoke references on table "public"."escrow_transactions" from "anon";

revoke select on table "public"."escrow_transactions" from "anon";

revoke trigger on table "public"."escrow_transactions" from "anon";

revoke truncate on table "public"."escrow_transactions" from "anon";

revoke update on table "public"."escrow_transactions" from "anon";

revoke delete on table "public"."escrow_transactions" from "authenticated";

revoke references on table "public"."escrow_transactions" from "authenticated";

revoke trigger on table "public"."escrow_transactions" from "authenticated";

revoke truncate on table "public"."escrow_transactions" from "authenticated";

revoke delete on table "public"."gear" from "anon";

revoke insert on table "public"."gear" from "anon";

revoke references on table "public"."gear" from "anon";

revoke trigger on table "public"."gear" from "anon";

revoke truncate on table "public"."gear" from "anon";

revoke update on table "public"."gear" from "anon";

revoke delete on table "public"."gear" from "authenticated";

revoke references on table "public"."gear" from "authenticated";

revoke trigger on table "public"."gear" from "authenticated";

revoke truncate on table "public"."gear" from "authenticated";

revoke delete on table "public"."gear_photos" from "anon";

revoke insert on table "public"."gear_photos" from "anon";

revoke references on table "public"."gear_photos" from "anon";

revoke trigger on table "public"."gear_photos" from "anon";

revoke truncate on table "public"."gear_photos" from "anon";

revoke update on table "public"."gear_photos" from "anon";

revoke references on table "public"."gear_photos" from "authenticated";

revoke trigger on table "public"."gear_photos" from "authenticated";

revoke truncate on table "public"."gear_photos" from "authenticated";

revoke delete on table "public"."gear_specifications" from "anon";

revoke insert on table "public"."gear_specifications" from "anon";

revoke references on table "public"."gear_specifications" from "anon";

revoke trigger on table "public"."gear_specifications" from "anon";

revoke truncate on table "public"."gear_specifications" from "anon";

revoke update on table "public"."gear_specifications" from "anon";

revoke references on table "public"."gear_specifications" from "authenticated";

revoke trigger on table "public"."gear_specifications" from "authenticated";

revoke truncate on table "public"."gear_specifications" from "authenticated";

revoke delete on table "public"."handover_photos" from "anon";

revoke insert on table "public"."handover_photos" from "anon";

revoke references on table "public"."handover_photos" from "anon";

revoke select on table "public"."handover_photos" from "anon";

revoke trigger on table "public"."handover_photos" from "anon";

revoke truncate on table "public"."handover_photos" from "anon";

revoke update on table "public"."handover_photos" from "anon";

revoke delete on table "public"."handover_photos" from "authenticated";

revoke references on table "public"."handover_photos" from "authenticated";

revoke trigger on table "public"."handover_photos" from "authenticated";

revoke truncate on table "public"."handover_photos" from "authenticated";

revoke delete on table "public"."message_threads" from "anon";

revoke insert on table "public"."message_threads" from "anon";

revoke references on table "public"."message_threads" from "anon";

revoke select on table "public"."message_threads" from "anon";

revoke trigger on table "public"."message_threads" from "anon";

revoke truncate on table "public"."message_threads" from "anon";

revoke update on table "public"."message_threads" from "anon";

revoke delete on table "public"."message_threads" from "authenticated";

revoke references on table "public"."message_threads" from "authenticated";

revoke trigger on table "public"."message_threads" from "authenticated";

revoke truncate on table "public"."message_threads" from "authenticated";

revoke delete on table "public"."messages" from "anon";

revoke insert on table "public"."messages" from "anon";

revoke references on table "public"."messages" from "anon";

revoke select on table "public"."messages" from "anon";

revoke trigger on table "public"."messages" from "anon";

revoke truncate on table "public"."messages" from "anon";

revoke update on table "public"."messages" from "anon";

revoke delete on table "public"."messages" from "authenticated";

revoke references on table "public"."messages" from "authenticated";

revoke trigger on table "public"."messages" from "authenticated";

revoke truncate on table "public"."messages" from "authenticated";

revoke delete on table "public"."moderation_queue" from "anon";

revoke insert on table "public"."moderation_queue" from "anon";

revoke references on table "public"."moderation_queue" from "anon";

revoke select on table "public"."moderation_queue" from "anon";

revoke trigger on table "public"."moderation_queue" from "anon";

revoke truncate on table "public"."moderation_queue" from "anon";

revoke update on table "public"."moderation_queue" from "anon";

revoke delete on table "public"."moderation_queue" from "authenticated";

revoke references on table "public"."moderation_queue" from "authenticated";

revoke trigger on table "public"."moderation_queue" from "authenticated";

revoke truncate on table "public"."moderation_queue" from "authenticated";

revoke update on table "public"."moderation_queue" from "authenticated";

revoke delete on table "public"."notifications" from "anon";

revoke insert on table "public"."notifications" from "anon";

revoke references on table "public"."notifications" from "anon";

revoke select on table "public"."notifications" from "anon";

revoke trigger on table "public"."notifications" from "anon";

revoke truncate on table "public"."notifications" from "anon";

revoke update on table "public"."notifications" from "anon";

revoke delete on table "public"."notifications" from "authenticated";

revoke insert on table "public"."notifications" from "authenticated";

revoke references on table "public"."notifications" from "authenticated";

revoke trigger on table "public"."notifications" from "authenticated";

revoke truncate on table "public"."notifications" from "authenticated";

revoke delete on table "public"."photo_uploads" from "anon";

revoke insert on table "public"."photo_uploads" from "anon";

revoke references on table "public"."photo_uploads" from "anon";

revoke select on table "public"."photo_uploads" from "anon";

revoke trigger on table "public"."photo_uploads" from "anon";

revoke truncate on table "public"."photo_uploads" from "anon";

revoke update on table "public"."photo_uploads" from "anon";

revoke delete on table "public"."photo_uploads" from "authenticated";

revoke references on table "public"."photo_uploads" from "authenticated";

revoke trigger on table "public"."photo_uploads" from "authenticated";

revoke truncate on table "public"."photo_uploads" from "authenticated";

revoke delete on table "public"."platform_settings" from "anon";

revoke insert on table "public"."platform_settings" from "anon";

revoke references on table "public"."platform_settings" from "anon";

revoke trigger on table "public"."platform_settings" from "anon";

revoke truncate on table "public"."platform_settings" from "anon";

revoke update on table "public"."platform_settings" from "anon";

revoke delete on table "public"."platform_settings" from "authenticated";

revoke insert on table "public"."platform_settings" from "authenticated";

revoke references on table "public"."platform_settings" from "authenticated";

revoke trigger on table "public"."platform_settings" from "authenticated";

revoke truncate on table "public"."platform_settings" from "authenticated";

revoke update on table "public"."platform_settings" from "authenticated";

revoke delete on table "public"."rate_limits" from "anon";

revoke insert on table "public"."rate_limits" from "anon";

revoke references on table "public"."rate_limits" from "anon";

revoke select on table "public"."rate_limits" from "anon";

revoke trigger on table "public"."rate_limits" from "anon";

revoke truncate on table "public"."rate_limits" from "anon";

revoke update on table "public"."rate_limits" from "anon";

revoke delete on table "public"."rate_limits" from "authenticated";

revoke references on table "public"."rate_limits" from "authenticated";

revoke trigger on table "public"."rate_limits" from "authenticated";

revoke truncate on table "public"."rate_limits" from "authenticated";

revoke delete on table "public"."reviews" from "anon";

revoke insert on table "public"."reviews" from "anon";

revoke references on table "public"."reviews" from "anon";

revoke select on table "public"."reviews" from "anon";

revoke trigger on table "public"."reviews" from "anon";

revoke truncate on table "public"."reviews" from "anon";

revoke update on table "public"."reviews" from "anon";

revoke delete on table "public"."reviews" from "authenticated";

revoke references on table "public"."reviews" from "authenticated";

revoke trigger on table "public"."reviews" from "authenticated";

revoke truncate on table "public"."reviews" from "authenticated";

revoke delete on table "public"."transactions" from "anon";

revoke insert on table "public"."transactions" from "anon";

revoke references on table "public"."transactions" from "anon";

revoke select on table "public"."transactions" from "anon";

revoke trigger on table "public"."transactions" from "anon";

revoke truncate on table "public"."transactions" from "anon";

revoke update on table "public"."transactions" from "anon";

revoke delete on table "public"."transactions" from "authenticated";

revoke references on table "public"."transactions" from "authenticated";

revoke trigger on table "public"."transactions" from "authenticated";

revoke truncate on table "public"."transactions" from "authenticated";

revoke delete on table "public"."trigger_debug" from "anon";

revoke insert on table "public"."trigger_debug" from "anon";

revoke references on table "public"."trigger_debug" from "anon";

revoke select on table "public"."trigger_debug" from "anon";

revoke trigger on table "public"."trigger_debug" from "anon";

revoke truncate on table "public"."trigger_debug" from "anon";

revoke update on table "public"."trigger_debug" from "anon";

revoke delete on table "public"."trigger_debug" from "authenticated";

revoke insert on table "public"."trigger_debug" from "authenticated";

revoke references on table "public"."trigger_debug" from "authenticated";

revoke select on table "public"."trigger_debug" from "authenticated";

revoke trigger on table "public"."trigger_debug" from "authenticated";

revoke truncate on table "public"."trigger_debug" from "authenticated";

revoke update on table "public"."trigger_debug" from "authenticated";

revoke delete on table "public"."trigger_debug" from "service_role";

revoke insert on table "public"."trigger_debug" from "service_role";

revoke references on table "public"."trigger_debug" from "service_role";

revoke select on table "public"."trigger_debug" from "service_role";

revoke trigger on table "public"."trigger_debug" from "service_role";

revoke truncate on table "public"."trigger_debug" from "service_role";

revoke update on table "public"."trigger_debug" from "service_role";

revoke delete on table "public"."users" from "anon";

revoke insert on table "public"."users" from "anon";

revoke references on table "public"."users" from "anon";

revoke trigger on table "public"."users" from "anon";

revoke truncate on table "public"."users" from "anon";

revoke update on table "public"."users" from "anon";

revoke delete on table "public"."users" from "authenticated";

revoke references on table "public"."users" from "authenticated";

revoke trigger on table "public"."users" from "authenticated";

revoke truncate on table "public"."users" from "authenticated";

CREATE INDEX idx_gear_location_coords ON public.gear USING gist (ll_to_earth((latitude)::double precision, (longitude)::double precision)) WHERE ((latitude IS NOT NULL) AND (longitude IS NOT NULL));

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.calculate_booking_total(p_daily_rate numeric, p_start_date date, p_end_date date, p_platform_fee_percentage integer DEFAULT 13)
 RETURNS TABLE(total_days integer, total_amount numeric, platform_fee numeric, owner_amount numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        (p_end_date - p_start_date + 1)::INTEGER as total_days,
        (p_daily_rate * (p_end_date - p_start_date + 1))::DECIMAL(10,2) as total_amount,
        ((p_daily_rate * (p_end_date - p_start_date + 1)) * p_platform_fee_percentage / 100)::DECIMAL(10,2) as platform_fee,
        ((p_daily_rate * (p_end_date - p_start_date + 1)) * (100 - p_platform_fee_percentage) / 100)::DECIMAL(10,2) as owner_amount;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.calculate_platform_fee(rental_amount integer)
 RETURNS integer
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
BEGIN
  RETURN ROUND(rental_amount * 0.13);
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_auth_rate_limit(action_type text DEFAULT 'auth_attempt'::text, max_attempts integer DEFAULT 5, window_minutes integer DEFAULT 15, lockout_minutes integer DEFAULT 30)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  current_count INTEGER;
  window_start TIMESTAMPTZ;
  lockout_start TIMESTAMPTZ;
  last_attempt TIMESTAMPTZ;
BEGIN
  -- Get current window start
  window_start := now() - (window_minutes || ' minutes')::INTERVAL;
  lockout_start := now() - (lockout_minutes || ' minutes')::INTERVAL;
  
  -- Get last attempt time
  SELECT MAX(created_at) INTO last_attempt
  FROM public.rate_limits
  WHERE user_id = auth.uid()
    AND action_type = check_auth_rate_limit.action_type;
  
  -- Count attempts in current window
  SELECT COALESCE(SUM(action_count), 0) INTO current_count
  FROM public.rate_limits
  WHERE user_id = auth.uid()
    AND action_type = check_auth_rate_limit.action_type
    AND created_at > window_start;
  
  -- Check if still in lockout period
  IF current_count >= max_attempts AND last_attempt > lockout_start THEN
    RETURN FALSE;
  END IF;
  
  -- Reset if lockout period has passed
  IF last_attempt IS NOT NULL AND last_attempt <= lockout_start THEN
    DELETE FROM public.rate_limits
    WHERE user_id = auth.uid()
      AND action_type = check_auth_rate_limit.action_type;
    current_count := 0;
  END IF;
  
  -- Record this attempt
  INSERT INTO public.rate_limits (user_id, action_type)
  VALUES (auth.uid(), check_auth_rate_limit.action_type);
  
  RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_rate_limit(action_type text, max_actions integer DEFAULT 10, window_minutes integer DEFAULT 60)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  current_count INTEGER;
  window_start TIMESTAMPTZ;
BEGIN
  -- Get current window start
  window_start := now() - (window_minutes || ' minutes')::INTERVAL;
  
  -- Count actions in current window
  SELECT COALESCE(SUM(action_count), 0) INTO current_count
  FROM public.rate_limits
  WHERE user_id = auth.uid()
    AND action_type = check_rate_limit.action_type
    AND created_at > window_start;
  
  -- Check if limit exceeded
  IF current_count >= max_actions THEN
    RETURN FALSE;
  END IF;
  
  -- Record this action
  INSERT INTO public.rate_limits (user_id, action_type)
  VALUES (auth.uid(), check_rate_limit.action_type);
  
  RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.check_trigger_debug()
 RETURNS TABLE(event_type text, user_id uuid, message text, created_at timestamp with time zone)
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  RETURN QUERY
  SELECT td.event_type, td.user_id, td.message, td.created_at
  FROM public.trigger_debug td
  ORDER BY td.created_at DESC
  LIMIT 20;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.create_notification(p_user_id uuid, p_type text, p_title text, p_message text, p_data jsonb DEFAULT NULL::jsonb)
 RETURNS uuid
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_notification_id UUID;
BEGIN
    INSERT INTO public.notifications (user_id, type, title, message, data)
    VALUES (p_user_id, p_type, p_title, p_message, p_data)
    RETURNING id INTO v_notification_id;
    
    RETURN v_notification_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_avatar_url(avatar_path text)
 RETURNS text
 LANGUAGE sql
 STABLE
AS $function$
  SELECT CASE 
    WHEN avatar_path IS NULL OR avatar_path = '' THEN NULL
    WHEN avatar_path LIKE 'http%' THEN avatar_path
    ELSE 'https://wnrbxwzeshgblkfidayb.supabase.co/storage/v1/object/public/avatars/' || avatar_path
  END;
$function$
;

CREATE OR REPLACE FUNCTION public.get_overdue_pickups(cutoff_date timestamp with time zone)
 RETURNS TABLE(id uuid, renter_id uuid, owner_id uuid, gear_title text)
 LANGUAGE sql
 STABLE
AS $function$
SELECT b.id, b.renter_id, b.owner_id, g.title
FROM public.bookings b
JOIN public.gear g ON g.id = b.gear_id
WHERE b.status = 'confirmed'
  AND (b.pickup_lat IS NULL OR b.pickup_lng IS NULL)
  AND b.start_date < cutoff_date::date;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_new_user()
 RETURNS trigger
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  user_email TEXT;
  user_metadata JSONB;
  first_name TEXT;
  last_name TEXT;
  full_name TEXT;
  location TEXT;
  phone TEXT;
  avatar_url TEXT;
BEGIN
  -- Log to debug table
  INSERT INTO public.trigger_debug (event_type, user_id, message) 
  VALUES ('TRIGGER_STARTED', NEW.id, 'Auth trigger called for user: ' || NEW.id);
  
  -- Extract user data safely
  user_email := COALESCE(NEW.email, '');
  user_metadata := COALESCE(NEW.raw_user_meta_data, '{}'::jsonb);
  
  -- Extract metadata fields with better fallback handling
  first_name := COALESCE(user_metadata->>'first_name', '');
  last_name := COALESCE(user_metadata->>'last_name', '');
  full_name := COALESCE(user_metadata->>'full_name', '');
  location := COALESCE(user_metadata->>'location', '');
  phone := COALESCE(user_metadata->>'phone', '');
  avatar_url := COALESCE(user_metadata->>'avatar_url', '');
  
  -- If full_name is empty but we have first_name and last_name, construct it
  IF full_name = '' AND (first_name != '' OR last_name != '') THEN
    full_name := TRIM(first_name || ' ' || last_name);
  END IF;
  
  -- If first_name is empty but we have full_name, extract it
  IF first_name = '' AND full_name != '' THEN
    first_name := SPLIT_PART(full_name, ' ', 1);
    last_name := TRIM(SUBSTRING(full_name FROM LENGTH(first_name) + 1));
  END IF;
  
  -- Log extracted data
  INSERT INTO public.trigger_debug (event_type, user_id, message) 
  VALUES ('DATA_EXTRACTED', NEW.id, 'Email: ' || user_email || ', Full name: ' || full_name || ', Location: ' || location);
  
  -- Check if user already exists
  IF EXISTS (SELECT 1 FROM public.users WHERE id = NEW.id) THEN
    INSERT INTO public.trigger_debug (event_type, user_id, message) 
    VALUES ('USER_EXISTS', NEW.id, 'User profile already exists');
    RETURN NEW;
  END IF;
  
  -- Insert user profile
  INSERT INTO public.users (
    id, 
    email, 
    first_name, 
    last_name, 
    full_name,
    avatar_url, 
    location, 
    phone,
    role, 
    is_verified, 
    is_suspended, 
    rating, 
    total_reviews, 
    total_rentals, 
    total_earnings
  )
  VALUES (
    NEW.id,
    user_email,
    first_name,
    last_name,
    full_name,
    avatar_url,
    location,
    phone,
    'user',
    false,
    false,
    0.00,
    0,
    0,
    0.00
  );
  
  INSERT INTO public.trigger_debug (event_type, user_id, message) 
  VALUES ('PROFILE_CREATED', NEW.id, 'User profile created successfully');
  
  RETURN NEW;
  
EXCEPTION
  WHEN unique_violation THEN
    INSERT INTO public.trigger_debug (event_type, user_id, message) 
    VALUES ('UNIQUE_VIOLATION', NEW.id, 'User profile already exists (unique_violation)');
    RETURN NEW;
  WHEN OTHERS THEN
    INSERT INTO public.trigger_debug (event_type, user_id, message) 
    VALUES ('ERROR', NEW.id, 'Error: ' || SQLERRM || ' (SQLSTATE: ' || SQLSTATE || ')');
    RAISE EXCEPTION 'Failed to create user profile: %', SQLERRM;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.handle_updated_at()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.is_account_locked(user_email text)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  lockout_start TIMESTAMPTZ;
  attempt_count INTEGER;
BEGIN
  -- Check for failed login attempts in last 30 minutes
  lockout_start := now() - INTERVAL '30 minutes';
  
  SELECT COALESCE(SUM(action_count), 0) INTO attempt_count
  FROM public.rate_limits rl
  JOIN public.users u ON u.id = rl.user_id
  WHERE u.email = is_account_locked.user_email
    AND rl.action_type = 'auth_attempt'
    AND rl.created_at > lockout_start;
  
  RETURN attempt_count >= 5;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.log_auth_event(event_type text, user_id uuid DEFAULT NULL::uuid, details jsonb DEFAULT '{}'::jsonb, ip_address inet DEFAULT NULL::inet, user_agent text DEFAULT NULL::text)
 RETURNS uuid
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
DECLARE
  event_id UUID;
BEGIN
  INSERT INTO public.analytics (
    event_type,
    user_id,
    data,
    ip_address,
    user_agent
  ) VALUES (
    'auth_' || event_type,
    COALESCE(user_id, auth.uid()),
    details,
    ip_address,
    user_agent
  ) RETURNING id INTO event_id;
  
  RETURN event_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.sync_gear_availability()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NEW.status = 'available' THEN
    NEW.is_available := true;
  ELSE
    NEW.is_available := false;
  END IF;
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.trigger_update_user_rating()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        PERFORM update_user_rating(NEW.reviewed_id);
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        PERFORM update_user_rating(OLD.reviewed_id);
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_booking_payment_status()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  -- Update booking payment status based on transaction status
  IF NEW.status = 'completed' THEN
    UPDATE public.bookings 
    SET payment_status = 'paid'
    WHERE id = NEW.booking_id;
  ELSIF NEW.status = 'failed' THEN
    UPDATE public.bookings 
    SET payment_status = 'failed'
    WHERE id = NEW.booking_id;
  ELSIF NEW.status = 'refunded' THEN
    UPDATE public.bookings 
    SET payment_status = 'refunded'
    WHERE id = NEW.booking_id;
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.update_user_rating(p_user_id uuid)
 RETURNS void
 LANGUAGE plpgsql
AS $function$
BEGIN
    UPDATE public.users 
    SET 
        rating = (
            SELECT COALESCE(AVG(rating), 0)
            FROM public.reviews 
            WHERE reviewed_id = p_user_id AND moderation_status = 'approved'
        ),
        total_reviews = (
            SELECT COUNT(*)
            FROM public.reviews 
            WHERE reviewed_id = p_user_id AND moderation_status = 'approved'
        )
    WHERE id = p_user_id;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_gear_before_insert_update()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NOT public.validate_gear_input(NEW.title, NEW.description, NEW.price_per_day) THEN
    RAISE EXCEPTION 'Invalid gear data provided';
  END IF;
  
  RETURN NEW;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_gear_input(gear_name text, gear_description text, price_per_day integer)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
AS $function$
BEGIN
  -- Validate name length and content
  IF gear_name IS NULL OR LENGTH(gear_name) < 3 OR LENGTH(gear_name) > 100 THEN
    RETURN FALSE;
  END IF;
  
  -- Check for suspicious content patterns
  IF gear_name ~* '(script|javascript|<|>|onclick|onerror)' THEN
    RETURN FALSE;
  END IF;
  
  -- Validate description length
  IF gear_description IS NOT NULL AND LENGTH(gear_description) > 2000 THEN
    RETURN FALSE;
  END IF;
  
  -- Validate price
  IF price_per_day IS NULL OR price_per_day < 0 OR price_per_day > 100000000 THEN
    RETURN FALSE;
  END IF;
  
  RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_payment_amounts(rental_amount integer, deposit_amount integer, platform_fee integer)
 RETURNS boolean
 LANGUAGE plpgsql
 IMMUTABLE
AS $function$
BEGIN
  -- Validate rental amount
  IF rental_amount IS NULL OR rental_amount <= 0 OR rental_amount > 100000000 THEN
    RETURN FALSE;
  END IF;
  
  -- Validate deposit amount (can be 0)
  IF deposit_amount IS NULL OR deposit_amount < 0 OR deposit_amount > 100000000 THEN
    RETURN FALSE;
  END IF;
  
  -- Validate platform fee
  IF platform_fee IS NULL OR platform_fee < 0 OR platform_fee > 100000000 THEN
    RETURN FALSE;
  END IF;
  
  -- Validate that platform fee is 13% of rental amount (with small tolerance for rounding)
  IF ABS(platform_fee - ROUND(rental_amount * 0.13)) > 1 THEN
    RETURN FALSE;
  END IF;
  
  RETURN TRUE;
END;
$function$
;

CREATE OR REPLACE FUNCTION public.validate_transaction_amounts()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
  IF NOT public.validate_payment_amounts(NEW.rental_amount, NEW.deposit_amount, NEW.platform_fee) THEN
    RAISE EXCEPTION 'Invalid payment amounts provided';
  END IF;
  
  -- Ensure total amount matches
  IF NEW.amount != (NEW.rental_amount + NEW.deposit_amount + NEW.platform_fee) THEN
    RAISE EXCEPTION 'Total amount does not match sum of components';
  END IF;
  
  RETURN NEW;
END;
$function$
;


